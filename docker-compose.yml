version: '3.7'
services:
  frontend:
    image: frontend-image
    ports:
      - '80:80'
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost']
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    image: backend-image
    ports:
      - '5000:5000'
    networks:
      - app-network
    environment:
      - DATABASE_URL=mongodb://mongo:27017/db
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5000']
      interval: 30s
      timeout: 10s
      retries: 3

  mongo:
    image: mongo
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'mongo', '--eval', 'db.runCommand({ ping: 1 })']
      interval: 30s
      timeout: 10s
      retries: 3

  monitoring:
    image: monitoring-image
    ports:
      - '9090:9090'
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9090']
      interval: 30s
      timeout: 10s
      retries: 3

  federated-learning:
    image: federated-learning-image
    networks:
      - app-network
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure

networks:
  app-network:
    driver: bridge