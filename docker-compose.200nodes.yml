# Sovereign Map Federated Learning - 200 Node Scale Fix
# This file is optimized for high-density deployment (25 nodes per host)
version: '3.8'

services:
  # ==========================================
  # Infrastructure Services (Shared on Host)
  # ==========================================
  mongo:
    image: mongo:7.0
    container_name: mongo-200
    # Host mode networking for high-speed I/O access by nodes
    network_mode: "host"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: sovereign2026
    restart: always
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s

  redis:
    image: redis:7-alpine
    container_name: redis-200
    network_mode: "host"
    restart: always

  # ==========================================
  # Sovereign Client Nodes (25 Replicas)
  # ==========================================
  node-agent:
    image: ${DOCKER_IMAGE_NAME:-federated-learning:latest}
    deploy:
      replicas: 25
      resources:
        limits:
          memory: ${DOCKER_MEM_LIMIT:-1g}
        reservations:
          cpus: '${DOCKER_CPU_RESERVATION:-0.5}'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    environment:
      # Connection to the central Genesis Node
      - AGGREGATOR_URL=http://${AGGREGATOR_IP}:8081
      # Local Database/Cache (Connecting via localhost due to host networking)
      - DATABASE_URI=mongodb://admin:sovereign2026@127.0.0.1:27017/sovereign_200?authSource=admin
      - REDIS_URI=redis://127.0.0.1:6379
      # Training Hyperparameters
      - LOCAL_EPOCHS=${LOCAL_EPOCHS:-3}
      - BATCH_SIZE=${BATCH_SIZE:-32}
      - PRIVACY_EPSILON=${PRIVACY_EPSILON:-4.0}
      - BFT_THRESHOLD=${BFT_THRESHOLD:-0.67}
      - LOG_LEVEL=info
      - DEBUG=false
    # FIX: Host networking bypasses the docker0 bridge bottleneck
    network_mode: "host"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ./test-data:/app/test-data:ro

volumes:
  mongo_data_200:
  redis_data_200:
